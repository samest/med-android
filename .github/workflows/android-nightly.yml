name: Android nightly build

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout branch
      uses: actions/checkout@v4 # Atualizado v3 -> v4
      with:
        ref: 'master'
    
    - name: Replace applicationId and name
      run: |
        sed -i 's/applicationId "xyz.zedler.patrick.med"/applicationId "xyz.zedler.patrick.med.nightly"/' app/build.gradle
        # Corrigido para garantir que o nome da app muda mesmo que o Grocy não esteja lá
        sed -i 's|name="app_name">.*<|name="app_name">Grocy Nightly<|g' app/src/main/res/values/strings.xml
        
    - name: Set up JDK 21 # Atualizado de 19 para 21
      uses: actions/setup-java@v4 # Atualizado v3 -> v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew assembleDebug # Alterado de 'build' para 'assembleDebug' para ser mais rápido e focado no APK
    
    - name: Rename artifacts
      run: |
        mkdir -p artifacts
        cp app/build/outputs/apk/debug/app-debug.apk artifacts/Grocy-Android-master-$(date +'%Y%m%d').apk
        [ -f app/src/main/res/raw/changelog.txt ] && cp app/src/main/res/raw/changelog.txt artifacts/changelog.txt || touch artifacts/changelog.txt
    
    - name: Upload artifacts
      uses: ncipollo/release-action@v1 # Sugestão de substituição por uma action mais estável
      with:
        allowUpdates: true
        tag: nightly
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: "artifacts/*"
